---
title: "DEPI Experiment Information"
author: "Abigail Seeger"
date: "June 29, 2020"
output:
  pdf_document: 
    toc: true
  html_document: default
---

```{r setup, include=FALSE}
library(formatR)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

# Load and Clean MPK Data
## Load packages
```{r message = FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(data.table)
library(ggthemes)
library(extrafont)
library(viridis)
library(reshape2)
```


```{r echo = FALSE}
add_day_col <- function(data_frame){
  unique_time <- sort(unique(data_frame$time_point))
  diff <- c()
  for (i in 1:length(unique_time)){
   if (i == 1){
      diff[1] <- 0
   }else{
      diff[i] <- unique_time[i] - unique_time[i-1]}}
  breaks <-c(0)
  for (i in 1:length(diff)){
    if (diff[i] > 5)
      breaks <- append(breaks, unique_time[i])}
  out <- data.frame()
  for (i in 1:length(breaks)){
    if (i == length(breaks)){
      indiv <- data_frame%>%filter(time_point >= breaks[i])%>%mutate(day = i)
   }else{
    indiv <- data_frame%>%filter(time_point >=breaks[i] & time_point < breaks[i+1])%>%mutate(day = i)}
    
    out <- rbind(as.data.frame(indiv), out)}
  return(out)}
```

## Load in December and February MPK data

Load in the data - this has data for the December and February experiments.

```{r echo = FALSE}
depi_temp <-read.table("DEPI_analysis_Seeger.txt", sep = ",", header = FALSE)
```

Include column names:

```{r echo = FALSE}
names(depi_temp) <- c("individual_plant_metadata", "genotype", 
                      "line", "subline", "border", "flat_number", 
                      "measurement_ID", "plant_ID", "measurement", "time_point", "measured_value")
```

Some of the time points have an "X" in front of them 
```{r }
x_subset <- depi_temp[which(grepl("X", depi_temp$time_point)),]
head(x_subset)

```

Investigate these values further:

```{r}
unique(substr(x_subset$plant_ID,1,4))
summary(x_subset)
```

So, only the December data has an "X" in its time_point. And, only growth and phi2 measurements have an "X" associated with it - not npq. 

Here, remove the X in front of the time points. Check with Siobhan to make sure I can use these time points!

```{r }
depi_temp$time_point <- as.numeric(gsub("X","", depi_temp$time_point))
```

Only use mpk genotypes, and subline 1 of Col0.

```{r echo = FALSE}
depi_temp_subset <- depi_temp%>%filter(!genotype %in% c("b1", "b3", "b1b3", "ftsz2-1", "ftsz2-2", "ftsz-dbl", "Col0" )|(genotype == "Col0"&subline == "1"))
```

Make both size and growth leafarea - these are the same measurements. 

```{r echo = FALSE}
###The December collection period has "growth", while the February collection period has "size"
###Both of these measurements are recording leaf area, so change both to leafarea
levels(depi_temp_subset$measurement)[levels(depi_temp_subset$measurement)=="size"] <- "leafarea"
levels(depi_temp_subset$measurement)[levels(depi_temp_subset$measurement)=="growth"] <- "leafarea"
```

Create dec_data and feb_data from the depi_subset. This will allow us to analyze each collection period seperately. 

```{r echo = FALSE}
###Create two data sets based on collection period and remove border plants 
feb_data <- filter(depi_temp_subset, substr(plant_ID, 1,4) == "0218", border == FALSE)
dec_data <- filter(depi_temp_subset, substr(plant_ID, 1,4) == "1217", border == FALSE)
```

## Load in January data

```{r echo = FALSE}
jan_temp <-read.table("DEPI_Jan_Seeger_Final.txt", sep = ",", header = FALSE)
```

We need to first add column names.

```{r echo = FALSE}
names(jan_temp) <- c("measurement_ID", "plant_ID", "DEPI_ID", "time_point", "measured_value", "light_regimen", "measurement", "individual_plant_metadata", "genotype", "line", "subline", "full_subline_information", "experiment_number", "flat_number","cell_number", "row_number", "column_number", "border", "treatment")

```

There are some genotypes that are not MPK mutants in this data set. Create a subset of only MPK mutants and wildtype Col0 to use in subsequent analysis. Also, only use subline 1 of Col0, because prior investigations have shown that other sublines may behave differently. 

```{r echo = FALSE}
jan_subset <- jan_temp%>%filter(!genotype %in% c("b1", "b3", "b1b3", "ftsz2-1", "ftsz2-2", "ftsz-dbl", "Col0" )|(genotype == "Col0"&subline == "1"))
```

Next, to stay consistent with the December and February data sets, rename growth to leaf area. 

```{r echo = FALSE}
###Growth is recording leaf area, so change to leafarea
levels(jan_subset$measurement)[levels(jan_subset$measurement)=="growth"] <- "leafarea"
```

There is no need to make subsets for experiment - this data set is only January. But, rename as jan_data so that is clear. And, remove border plants. 

```{r echo = FALSE }
###Create two data sets based on collection period and remove border plants 
jan_data <- filter(jan_subset, border == FALSE)
```

## Create a data frame with all months

Also, add a column with the day using the add_day_col function. 

```{r echo = FALSE}
feb_data <- feb_data%>%select(individual_plant_metadata, genotype, flat_number, measurement, time_point, measured_value)%>%mutate(month = "Feb")
jan_data <- jan_data%>%select(individual_plant_metadata, genotype, flat_number, measurement, time_point, measured_value)%>%mutate(month = "Jan")
dec_data <- dec_data%>%select(individual_plant_metadata, genotype, flat_number, measurement, time_point, measured_value)%>%mutate(month = "Dec")

depi_all <- add_day_col(rbind(feb_data, jan_data, dec_data))

```

# Load and Clean Genotypes that Aren't MPK

```{r echo = FALSE}
dec_b1b3 <- depi_temp%>%filter(genotype %in% c("b1", "b3", "b1b3")|(genotype == "Col0"&subline == "1"))%>%filter(border == FALSE)%>%filter(substr(plant_ID,1,4)=="1217")%>%mutate(month = "Dec")

feb_b1b3 <- depi_temp%>%filter(genotype %in% c("b1", "b3", "b1b3")|(genotype == "Col0"&subline == "1"))%>%filter(border == FALSE)%>%filter(substr(plant_ID,1,4)=="0218")%>%mutate(month = "Feb")

feb_ftsz <- depi_temp%>%filter(genotype %in% c("ftsz2-1", "ftsz2-2", "ftsz-dbl" )|(genotype == "Col0"&subline == "2"))%>%filter(substr(plant_ID,1,4)=="0218")%>%mutate(month = "Feb")

dec_ftsz <- depi_temp%>%filter(genotype %in% c("ftsz2-1", "ftsz2-2", "ftsz-dbl" )|(genotype == "Col0"&subline == "2"))%>%filter(substr(plant_ID,1,4)=="1217")%>%mutate(month = "Dec")

jan_b1b3 <- jan_temp%>%filter(genotype %in% c("b1", "b3", "b1b3")|(genotype == "Col0"&subline == "1"))%>%filter(border == FALSE)%>%mutate(month = "Jan")

jan_ftsz <- jan_temp%>%filter(genotype %in% c("ftsz2-1", "ftsz2-2", "ftsz-dbl" )|(genotype == "Col0"&subline == "2"))%>%mutate(month = "Jan")

common_cols <- intersect(colnames(jan_b1b3), colnames(feb_ftsz))


not_mpk <- rbind(
  subset(dec_b1b3, select = common_cols), 
  subset(feb_b1b3, select = common_cols),
  subset(feb_ftsz, select = common_cols), 
  subset(dec_ftsz, select = common_cols),
  subset(jan_ftsz, select = common_cols), 
  subset(jan_b1b3, select = common_cols))

not_mpk$time_point <- as.numeric(gsub("X","", not_mpk$time_point))

not_mpk <- add_day_col(not_mpk)
levels(not_mpk$measurement)[levels(not_mpk$measurement)=="growth"] <- "leafarea"
levels(not_mpk$measurement)[levels(not_mpk$measurement)=="size"] <- "leafarea"

```

# MPK Genotypes

## Genotype Information

```{r echo = FALSE}
depi_all%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(month)%>%
  summarize(length(unique(genotype)))
```

The December experiment has one less genotype than the January and February experiments.

```{r echo = FALSE}
depi_all%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(genotype, month)%>%
  summarize(replicates = length(unique(individual_plant_metadata)))%>%
  spread(month, replicates)%>%
  print(n = Inf)
```

So, it looks like the December experiment does not have the mpk5-17 genotype. 

Also, note that some genotypes in December have very few replicates. 

## Experiment Length

Here is the length of each experiment, both in number of days and total hours of the experiment: 

```{r echo = FALSE}
depi_all%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(month)%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  arrange(month)%>%
  summarize(days = length(unique(day)), total_hours = max(time_point))
```

## Measured Values/Measurement/Day
```{r }
depi_all%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(measurement, day, month)%>%
  summarize(measurements = length(unique(time_point)))%>%
  spread(month, measurements)%>%
  print(n = Inf)

```


Note that the NA values make sense, because the experiment lengths are different.

It looks the February experiment has 32 measured values for sinusoidal days and 64 measured values for flucuating days for each measurement. But, the January experiment only has 16 or 17 measured values, regardless of day. And, the December experiment follows the same pattern as the February experiment, except there are only 15 or 16 measured values for npq. 

# Genotypes that aren't MPK 

Here is a summary of the genotypes that are not in the MPK gene family, but that we still have DEPI information for.

## Genotype Information

```{r echo = FALSE}
not_mpk%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(month)%>%
  summarize(length(unique(genotype)))
```

So, there are 7 genotypes that are either in the Ftsz family, B1B3 group, or wild type. 

Here are the number of replicates per genotype per experiment.

```{r echo = FALSE}
not_mpk%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(genotype, month)%>%
  summarize(replicates = length(unique(individual_plant_metadata)))%>%
  spread(month, replicates)%>%
  print(n = Inf)
```

So, it looks like all experiments have the same genotypes, though the number of replicates differs between them.

## Experiment Length

Here is the length of each experiment, both in number of days and total hours of the experiment: 

```{r echo = FALSE}
not_mpk%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(month)%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  arrange(month)%>%
  summarize(days = length(unique(day)), total_hours = max(time_point))
```

This makes sense - the plants were with the MPK genotypes in the DEPI chamber, so the experiment lengths are the same.

## Measured Values/Measurement/Day
 
```{r echo = FALSE}
not_mpk%>%
  mutate(month = factor(month, levels = c("Dec", "Jan", "Feb")))%>%
  group_by(measurement, day, month)%>%
  summarize(measurements = length(unique(time_point)))%>%
  spread(month, measurements)%>%
  print(n = Inf)

```

# Light Treatment

For each experiment, the lighting conditions are as follows:

* Day 2: Sinusoidal Light
* Days 3 and 5: Flucuating Light
* Days 1, 4, and 6 to the end of the experiment: Flat Light

# Additional Notes in Access

For the March 2018 experiment, **David Hall said plants were covered in thrips on 4/13/18. Plants were disposed of.**

(Currently, I do not have the March 2018 experiment data. There were no additional notes for the December, January, or February experiments.)